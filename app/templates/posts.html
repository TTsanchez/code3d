{% extends 'base2.html' %}

{% block title %}
Посты
{% endblock %}

{% block title2 %}
Посты
{% endblock %}

{% block body %}
<div id="postsContainer">
    <div class="container py-2">
        <!-- Кнопка для изменения порядка сортировки -->
        <button id="DataSort" onclick="toggleSort()">Data ↓↑</button>
        <p>Current Sort Value: {{ sort }}</p>
    </div>
    <section style="background-color: #eee;">
        {% for post in posts %}
        <div class="container py-2" id="post-{{ post.post_id }}">
            <div class="row justify-content-center" class="row">
                <div>
                    <div id="delete_post_bttn" data-post-id="{{ post.post_id }}">
                        <a href="#" class="d-block link-body-emphasis text-decoration-none"
                           data-bs-toggle="dropdown" aria-expanded="false">. . .
                        </a>
                        <ul class="dropdown-menu text-small" style="">
                            <li><a data-postid="{{ post.post_id }}" class="dropdown-item copyButton">Поделиться</a></li>
                            {% if post.user_id == current_user.user_id or current_user.superuser == True %}
                            <li>
                                <button onclick='del_post("{{ post.post_id }}")' data-post-id="{{ post.post_id }}"
                                        class="dropdown-item">Удалить
                                </button>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <a href="/user/{{post.username}}"><h6 class="mb-4">
                                            <img src="https://pro.guap.ru/images/no_image.jpg" width="32" height="32"
                                                 class="rounded-circle">{{post.username}}</h6>
                                        </a>
                                        <a class="href_post" href="/post/{{post.post_id}}" target="_blank">
                                            <h4 class="mb-4">{{post.title}}</h4>
                                        </a>
                                        <pre class="clamp-text" align="justify">
                                          {{ post.content[:340] }}{% if post.content|length > 300 %}...{% endif %}
                                        </pre>

                                        <h7 class="mb-4" data-utc-time="{{ post.created_at.isoformat() }}">
                                            <!-- Фолбэк для случаев без JavaScript -->
                                            <noscript>{{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') }} (UTC)
                                            </noscript>
                                        </h7>
                                    </div>
                                    <div id="canvas" class="col-sm-6">
                                        {% if post.technology3d == 'x3dom' %}
                                        <x3d width="100%" height="100%">
                                            {{post.code3d|safe}}
                                        </x3d>
                                        {% elif post.technology3d == 'verge3d' %}
                                        <iframe style="min-height: 300px; width: 100%;" allowfullscreen
                                                src="{{post.code3d|safe}}"></iframe>

                                        {% elif post.technology3d == 'three.js' %}
                                        <div id="canvas-container" style="max-height: 300px; width: 100%;">
                                            <canvas id="three-canvas" style="min-height: 300px; width: 100%;"></canvas>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </section>
</div>
<script src="https://www.x3dom.org/download/dev/x3dom-full.js"></script>
<!-- Подключение jQuery  -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<!-- скрипт для смены сортировки постов по дате -->
<script>
    function toggleSort() {
        // Получаем текущий порядок сортировки из URL
        var currentSort = "{{ sort }}" || "desc";
        const but_txt = document.getElementById('DataSort');

        // Переключаем между значениями сортировки
        currentSort = (currentSort === "asc") ? "desc" : "asc";

        // Обновляем URL с новым значением сортировки без перезагрузки
        var url = "{{ url_for('posts', sort='') }}" + currentSort;
        window.history.replaceState({}, document.title, url);

        // Перезагружаем страницу
        location.reload();
    }
</script>

<!--Копирование ссылки на пост-->
<script src="{{ url_for('static', filename='js/copy_post.js') }}"></script>
<!--Удаление поста-->
<script src="{{ url_for('static', filename='js/del_post.js') }}"></script>
<script src="{{ url_for('static', filename='js/3js_posts.js') }}"></script>
<script src="{{ url_for('static', filename='js/datetime-utils.js') }}"></script>
<script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>

{% endblock %}